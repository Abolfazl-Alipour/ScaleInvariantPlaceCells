#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Created on Sun Aug 14 11:31:46 2022

@author: panlab
"""
# import pandas as pd

import numpy as np
import matplotlib.pyplot as plt
import matplotlib
import seaborn as sns
import pytorch_lightning as pl
pl.seed_everything(1234)

import torch
import pandas as pd
import scipy
from matplotlib.patches import Wedge
import os
    
 

def plotPlaceFields(ValDataLogs,thresh,stdVal,criteria=0,maxLocationPossible=500,plotLogScaleToo=True):

    tmpListLocs = []

    for vv in range(len(ValDataLogs)):
        tmp = ValDataLogs[vv][0][:, :, 0]
        tmpListLocs.append(tmp)

    # breakpoint()
    locs = torch.cat(tmpListLocs)
    tmpListActivities = []
    # location=ValDataLogs[0][0][:,:,0:2]
    for vv in range(len(ValDataLogs)):
        tmp = ValDataLogs[vv][1]
        tmpListActivities.append(tmp)

    actvts = torch.cat(tmpListActivities)
    NoOfBins=int(maxLocationPossible/10)
    ActivityCollector = np.full([actvts.shape[2], NoOfBins], np.nan)
    plt.ioff()

    for neuronID in range(actvts.size(dim=2)):
        # criteria = (torch.mean(actvts[:, :, neuronID]) +
        #             torch.std(actvts[:, :, neuronID])*stdVal)
        if torch.max(actvts[:, :, neuronID]) > criteria:
            # print(neuronID)
            nrn = actvts[:, :, neuronID]
            activeIndz = nrn > criteria
            locsAndActvts = torch.stack([locs[activeIndz].cpu(), nrn[nrn > criteria]]).T
            # fig = plt.figure()
            # plt.plot( locsAndActvts[:,0],np.ones(locsAndActvts[:,0].shape[0]),'.k')
            # plt.hist(locsAndActvts[:,0])
            # ax1=sns.heatmap(LocHistArraySortedMax)
            # ax1.set_xticklabels(f'{c:.1f}' for c in np.arange(-100, 100, 8))
            # fig.savefig('singleRawData'+str(neuronID)+ '.png')
            
            firingSumsInEachBin = np.full([NoOfBins], 0.0)
            binIncrement=maxLocationPossible/NoOfBins
            for binNo in range(0,NoOfBins):
                binMembers = locsAndActvts[torch.where((locsAndActvts[:, 0] >= binNo*binIncrement) & (locsAndActvts[:, 0] < (binNo+1)*binIncrement))]
                # (100/NoOfBins)*(100/NoOfBins)
                if binMembers.shape[0]>0:
                    # print(binMembers)
                    firingSumsInEachBin[binNo] = torch.mean(binMembers[:,1])
            ActivityCollector[neuronID, :] = (firingSumsInEachBin)/np.max(firingSumsInEachBin)

    ActivityCollector4Time = np.full(
        [actvts.shape[2], actvts.shape[1]], np.nan)
    plt.ioff()
    for neuronID in range(actvts.size(dim=2)):
        # criteria = (torch.mean(actvts[:, :, neuronID]) +
        #             torch.std(actvts[:, :, neuronID])*stdVal)
        if torch.max(actvts[:, :, neuronID]) > criteria:
            ActivityCollector4Time[neuronID, :]=0
            # print(neuronID)
            for timeStepOfInput in range(actvts.shape[1]):
                nrn = actvts[:, :, neuronID]
                nrn = nrn[:, timeStepOfInput]
                # activeIndz=nrn>criteria
                # locsAndActvts=torch.stack([locs[trialNum,activeIndz].cpu(),nrn[nrn>criteria]]).T
                tmp=torch.mean(nrn[nrn > criteria])
                if tmp>0:
                    ActivityCollector4Time[neuronID, timeStepOfInput] = torch.mean(nrn[nrn > criteria])
            ActivityCollector4Time[neuronID, :] = ActivityCollector4Time[neuronID,:]/np.max(ActivityCollector4Time[neuronID, :])
    #l#########################ogPlots
    # breakpoint()
    NoOfBins4Log=np.floor_divide(NoOfBins,1)
    ActivityCollectorLog10=np.full([actvts.shape[2], NoOfBins4Log], np.nan)
    for neuronID in range(actvts.size(dim=2)):
        # criteria = (torch.mean(actvts[:, :, neuronID]) +
        #             torch.std(actvts[:, :, neuronID])*stdVal)
        if torch.max(actvts[:, :, neuronID]) > criteria:
            # print(neuronID)
            nrn = actvts[:, :, neuronID]
            activeIndz = nrn > criteria
            locsAndActvts = torch.stack([locs[activeIndz].cpu(), nrn[nrn > criteria]]).T
            # fig = plt.figure()
            # plt.plot( locsAndActvts[:,0],np.ones(locsAndActvts[:,0].shape[0]),'.k')
            # plt.hist(locsAndActvts[:,0])
            # ax1=sns.heatmap(LocHistArraySortedMax)
            # ax1.set_xticklabels(f'{c:.1f}' for c in np.arange(-100, 100, 8))
            # fig.savefig('singleRawData'+str(neuronID)+ '.png')
            
            firingSumsInEachBin = np.full([NoOfBins4Log], 0.0)
            binIncrement=np.logspace(np.log10(.001), np.log10(1800), NoOfBins4Log)
            
            for binNo in range(0,NoOfBins4Log):
                binMembers = locsAndActvts[torch.where((locsAndActvts[:, 0] >= binNo*binIncrement[binNo]) & (locsAndActvts[:, 0] < (binNo+1)*binIncrement[binNo]))]
                # (100/NoOfBins)*(100/NoOfBins)
                if binMembers.shape[0]>0:
                    # print(binMembers)
                    firingSumsInEachBin[binNo] = torch.mean(binMembers[:,1])
            ActivityCollectorLog10[neuronID, :] = (firingSumsInEachBin)/np.max(firingSumsInEachBin)

    FiringsUnsortedlog10 = ActivityCollectorLog10
    indxHolder = np.full([actvts.size(dim=2), 2], np.nan)
    for NeuronID in range(np.size(FiringsUnsortedlog10, axis=0)):
        indxHolder[NeuronID] = [NeuronID, np.argmax(FiringsUnsortedlog10[NeuronID])]

    indxHolder = indxHolder[~np.isnan(indxHolder[:, 1])]
    sortedIndcs = sorted(indxHolder, key=lambda indxHolder: indxHolder[1])
    LocHistArraySortedMaxlog10 = np.full(
        [np.size(FiringsUnsortedlog10, axis=0), np.size(FiringsUnsortedlog10, axis=1)], np.nan)

    for NeuronID in range(len(FiringsUnsortedlog10)):
        LocHistArraySortedMaxlog10[NeuronID] = FiringsUnsortedlog10[int(
            sortedIndcs[NeuronID][0])]
########################

    FiringsUnsorted = ActivityCollector
    indxHolder = np.full([actvts.size(dim=2), 2], np.nan)
    for NeuronID in range(np.size(FiringsUnsorted, axis=0)):
        indxHolder[NeuronID] = [NeuronID, np.argmax(FiringsUnsorted[NeuronID])]

    indxHolder = indxHolder[~np.isnan(indxHolder[:, 1])]
    sortedIndcs = sorted(indxHolder, key=lambda indxHolder: indxHolder[1])
    ### time ####
    indxHolderTime = np.full([actvts.size(dim=2), 2], np.nan)
    for NeuronID in range(np.size(FiringsUnsorted, axis=0)):
        indxHolderTime[NeuronID] = [NeuronID, np.argmax(ActivityCollector4Time[NeuronID])]

    indxHolderTime = indxHolderTime[~np.isnan(indxHolder[:, 1])]
    sortedIndcsTime = sorted(indxHolderTime, key=lambda indxHolderTime: indxHolderTime[1])
    ########  ######
    LocHistArraySortedMax = np.full(
        [np.size(FiringsUnsorted, axis=0), np.size(FiringsUnsorted, axis=1)], np.nan)

    for NeuronID in range(len(FiringsUnsorted)):
        LocHistArraySortedMax[NeuronID] = FiringsUnsorted[int(
            sortedIndcs[NeuronID][0])]

    TimeHistArraySortedMax = np.full(
        [np.size(ActivityCollector4Time, axis=0), np.size(ActivityCollector4Time, axis=1)], np.nan)

    for NeuronID in range(len(FiringsUnsorted)):
        TimeHistArraySortedMax[NeuronID] = ActivityCollector4Time[int(
            sortedIndcsTime[NeuronID][0])]
    ######## time matched to place cell orderings ######
    Time2LocMatchedHistArraySortedMax = np.full(
        [np.size(ActivityCollector4Time, axis=0), np.size(ActivityCollector4Time, axis=1)], np.nan)

    for NeuronID in range(len(FiringsUnsorted)):
        Time2LocMatchedHistArraySortedMax[NeuronID] = ActivityCollector4Time[int(
            sortedIndcs[NeuronID][0])]
    #################  
    LocHistArraySortedMaxlog10 = LocHistArraySortedMaxlog10[~np.isnan(
        LocHistArraySortedMaxlog10[:, 1])]
    LocHistArraySortedMax = LocHistArraySortedMax[~np.isnan(
        LocHistArraySortedMax[:, 1])]
    TimeHistArraySortedMax = TimeHistArraySortedMax[~np.isnan(
        TimeHistArraySortedMax[:, 1])]
    Time2LocMatchedHistArraySortedMax = Time2LocMatchedHistArraySortedMax[~np.isnan(
        Time2LocMatchedHistArraySortedMax[:, 1])]
    
    # This is for ploting Location and time profiles agoinst each other
    # plt.ioff()
    # for NeuronID in range(len(FiringsUnsorted)): 
    #     fig = plt.figure()
    #     plt.plot(ActivityCollector[NeuronID,:])
    #     plt.plot(ActivityCollector4Time[NeuronID,:])
    #     plt.legend(['Location','time'])
    #     fig.savefig('FiringProfileOfNeuron'+ str(NeuronID) +'LocationVsTime'+ '.png') 
    # breakpoint()
    # plt.ion()
    # fig = plt.figure()
    # ax1=sns.heatmap(LocHistArraySortedMax)
    # ax1.set_xticklabels(f'{c:.1f}' for c in np.arange(-100, 100, 8))
    # fig.savefig('HeatMapOfLocationFiringSortedBasedOnMaxFiring.png')
    
    # fig = plt.figure()
    # ax1=sns.heatmap(Time2LocMatchedHistArraySortedMax)
    # fig.savefig('HeatMapOfTimeFiringMatched2LocationMaxFiring.png')
    # fig = plt.figure()
    # ax1=sns.heatmap(TimeHistArraySortedMax)
    # fig.savefig('HeatMapOfTimeFiringSortedBasedOnMaxFiring.png')

    indxHolder = np.full([FiringsUnsorted.shape[0], 2], np.nan)
    indxHolder[:, 0] = range(FiringsUnsorted.shape[0])
    indxHolder[:, 1] = (FiringsUnsorted != 0).argmax(axis=1)

    sortedIndcs = sorted(indxHolder, key=lambda indxHolder: indxHolder[1])
    ### time ####
    indxHolderTime = np.full([actvts.size(dim=2), 2], np.nan)
    indxHolder[:, 0] = range(ActivityCollector4Time.shape[0])
    indxHolder[:, 1] = (ActivityCollector4Time != 0).argmax(axis=1)
    for NeuronID in range(np.size(FiringsUnsorted, axis=0)):
        indxHolderTime[NeuronID] = [NeuronID, np.argmax(ActivityCollector4Time[NeuronID])]

    indxHolderTime = indxHolderTime[~np.isnan(indxHolder[:, 1])]
    sortedIndcsTime = sorted(indxHolderTime, key=lambda indxHolderTime: indxHolderTime[1])
    #### time ####
    LocHistArraySortedFirts2Fire = np.full(
        [np.size(FiringsUnsorted, axis=0), np.size(FiringsUnsorted, axis=1)], np.nan)

    for NeuronID in range(len(FiringsUnsorted)):
        LocHistArraySortedFirts2Fire[NeuronID] = FiringsUnsorted[int(
            sortedIndcs[NeuronID][0])]

    TimeHistArraySortedFirts2Fire = np.full(
        [np.size(ActivityCollector4Time, axis=0), np.size(ActivityCollector4Time, axis=1)], np.nan)

    for NeuronID in range(len(FiringsUnsorted)):
        TimeHistArraySortedFirts2Fire[NeuronID] = ActivityCollector4Time[int(
            sortedIndcsTime[NeuronID][0])]

    LocHistArraySortedFirts2Fire = LocHistArraySortedFirts2Fire[~np.isnan(
        LocHistArraySortedFirts2Fire[:, 1])]
    TimeHistArraySortedFirts2Fire = TimeHistArraySortedFirts2Fire[~np.isnan(
        TimeHistArraySortedFirts2Fire[:, 1])]

    plt.ion()
    # fig = plt.figure()
    # ax1=sns.heatmap(LocHistArraySortedFirts2Fire)
    # ax1.set_xticklabels(f'{c:.1f}' for c in np.arange(-100, 100, 8))
    # fig.savefig('HeatMapOfLocationFiringSortedBasedOnFirstFiring.png')

    # fig = plt.figure()
    # sns.heatmap(TimeHistArraySortedFirts2Fire)
    # fig.savefig('HeatMapOfTimeFiringSortedBasedOnFirstFiring.png')
    # plotting one by one
    # plt.ioff()
    # for NeuronID in range(len(LocHistArraySortedFirts2Fire)):#
    #     fig = plt.figure()
    #     ax = plt.subplot(111)
    #     # ax.hist(locs[activeIndz].cpu(),100,[0,100])#linspace(0, 10,locs[activeIndz].shape[0])
    #     ax.plot(LocHistArraySortedFirts2Fire[NeuronID,:])
    #     ax.plot(TimeHistArraySortedFirts2Fire[NeuronID,:])
    #     ax.legend(['Location','Time'])
    #     # print(locs[activeIndz])
    #     # ax.scatter(locationPast[activeIndz,:].cpu()[:,0],locationPast[activeIndz,:].cpu()[:,1],marker='.',c='r')
    #     ax.set_xlim(0,100)
    #     # ax.set_ylim(0.95,1.05)
    #     # plt.title('Neuron'+str(neuronID))
    #     # ax.legend('FiringLocation')
    #     # plt.show()
    #     fig.savefig('Neuron'+str(NeuronID)+'TimeVsLocation.png')
    #     plt.close(fig)

            


        
        
    # locCollectorEven=[]
    # locCollectorOdd=[]
    # for neuronID in range(actvts.size(dim=2)):#
    #     for trialNum in range(actvts.shape[0]):#
    #         if trialNum%2==0:
    #             nrnEven=actvts[trialNum,:,neuronID]
    #             if nrnEven.any()>(torch.mean(nrnEven)+torch.std(nrnEven)*stdVal):
    #                 activeIndzEven=nrnEven>(torch.mean(nrnEven)+torch.std(nrnEven)*stdVal)
    #                 locCollectorEven.append(locs[trialNum,activeIndzEven].cpu())
    #         else:
    #             nrnOdd=actvts[trialNum,:,neuronID]
    #             if nrnOdd.any()>(torch.mean(nrnOdd)+torch.std(nrnOdd)*stdVal):
    #                 activeIndzOdd=nrnOdd>(torch.mean(nrnOdd)+torch.std(nrnOdd)*stdVal)
    #                 locCollectorOdd.append(locs[trialNum,activeIndzOdd].cpu())               
     
    return [LocHistArraySortedMax,TimeHistArraySortedMax,LocHistArraySortedFirts2Fire,TimeHistArraySortedFirts2Fire,Time2LocMatchedHistArraySortedMax,LocHistArraySortedMaxlog10]      



def plotPlaceFields2D(ValDataLogs,thresh=0,stdVal=0,criteria=0,maxLocationPossible=800):


    tmpListLocs = []

    # for vv in range(len(ValDataLogs)):
    #     tmp = ValDataLogs[vv][0][:, :, 0:2]
    #     tmpListLocs.append(tmp)
    for vv in range(len(ValDataLogs)):
        tmp = torch.vstack([np.cumsum(ValDataLogs[vv][0][:-1,2])*np.cos(ValDataLogs[vv][0][1:,3]),np.cumsum(ValDataLogs[vv][0][:-1,2])*np.sin(ValDataLogs[vv][0][1:,3])])
        tmpListLocs.append(tmp.T)
    # breakpoint()
    locs = torch.cat(tmpListLocs)
    tmpListActivities = []
    # location=ValDataLogs[0][0][:,:,0:2]
    for vv in range(len(ValDataLogs)):
        tmp = ValDataLogs[vv][1][1:,:]
        tmpListActivities.append(tmp)

    actvts = torch.cat(tmpListActivities)
    maxLocationPossible=maxLocationPossible

    activeNrnCounter=[]
    # PlaceFields=[]
    # import colorcet as cc
    # import matplotlib.colors as colors
    # import matplotlib.pyplot as plt
    # from fast_histogram import histogram2d
    
    for neuronID in range(actvts.size(dim=1)):
    # for neuronID in range(15):
        # criteria = (torch.mean(actvts[:, :, neuronID]) +
        #             torch.std(actvts[:, :, neuronID])*stdVal)
        # criteria=0
        if torch.max(actvts[:, neuronID]) > criteria:
            
            nrn = actvts[ :, neuronID]
            # print(nrn)
            activeIndz = nrn> criteria
            nrnThresholded=nrn[activeIndz]
            if len(nrnThresholded)>3:
                print(neuronID)
                plt.ioff()
                
                activeNrnCounter.append(neuronID)
                Xlocs=torch.squeeze(locs[:,0])
                Xlocs=Xlocs[activeIndz]
                Ylocs=torch.squeeze(locs[:,1])
                Ylocs=Ylocs[activeIndz]
                #
                '''
                plt.ioff()
                fig=plt.figure(figsize=(15,15))
                ax=fig.add_subplot(111)
                ax.set_title("Trajectory agent")
                ax.plot(Xlocs, Ylocs,'.r')
                ax.set_xlim(-2200,2200)
                ax.set_ylim(-2200,2200)
                # '''
                
                # fig = plt.figure()
                # cmap = cc.cm["fire"].copy()
                # cmap.set_bad(cmap.get_under())  # set the color for 0
                # for rat sim
                # bounds = [[0,maxLocationPossible], [0,maxLocationPossible]]
                # for my Dset
    
                
                # define grid.
                # xi = np.linspace(0,maxLocationPossible,200)
                # yi = np.linspace(0,maxLocationPossible,200)
                
                xi,yi = np.mgrid[-maxLocationPossible:maxLocationPossible:50j, -maxLocationPossible:maxLocationPossible:50j]
                
                # grid_x, grid_y = np.mgrid[0:1:100j, 0:1:200j]
                # grid the data.
                zi = scipy.interpolate.griddata((Xlocs.cpu(),Ylocs.cpu()),nrnThresholded.cpu()*100000,(xi,yi),fill_value=0)
                
                #pcolormesh of interpolated uniform grid with log colormap
    
                            
                fig, ax = plt.subplots(figsize=(15, 15))
                plt.subplots_adjust(left=0, right=1, bottom=0, top=1)
                ax.pcolormesh(xi,yi,zi,norm=matplotlib.colors.Normalize(),cmap = 'plasma')#,cmap = 'plasma',norm=matplotlib.colors.LogNorm()
                breakpoint()
                wedge = Wedge((0.5, 0.5), 1.5, 0, 360, width=1.2, transform=ax.transAxes, facecolor='white', edgecolor='none')
                ax.add_patch(wedge)
                ax.set_aspect('equal')
                ax.set_position([0, 0, 1, 1])
                plt.axis('off')
                fig.savefig('2DNeuron'+str(neuronID)+'.png')
                plt.close()
    



            # plt.show()
            # # bounds = [[-maxLocationPossible,maxLocationPossible], [-maxLocationPossible,maxLocationPossible]]
            # plt.scatter(Xlocs.cpu(), Ylocs.cpu(), c=nrnThresholded.cpu(),edgecolors='none', norm=matplotlib.colors.LogNorm())
            # h = histogram2d(Xlocs.cpu(),Ylocs.cpu(), range=bounds, bins=400)
            # if h.max()>0:
            #     plt.imshow(np.flipud(h), norm=colors.LogNorm(vmin=1, vmax=h.max()), cmap=cmap)
            #     # plt.gca().invert_yaxis()
            #     # plt.gca().invert_xaxis()
            #     # plt.axis('off')
            #     plt.colorbar()
            #     # plt.show()
            #     # plt.scatter(Xlocs.cpu(),Ylocs.cpu(),s=.1, alpha=0.1)
            #     # plt.xlim([-maxLocationPossible,maxLocationPossible])
            #     # plt.ylim([-maxLocationPossible,maxLocationPossible])
            #     fig.savefig('2DNeuron'+str(neuronID)+'.png')
            #     plt.close()
            #     PlaceFields.append([Xlocs,Ylocs])

     
    return #PlaceFields#[LocHistArraySortedMax,TimeHistArraySortedMax,LocHistArraySortedFirts2Fire,TimeHistArraySortedFirts2Fire]      
############################3










#%%

def histTimes(ValDataLogs,criteria=0):
    tmpListLocs=[]
    
    for vv in range(len(ValDataLogs)):
        tmp=ValDataLogs[vv][0][:,:,0]
        tmpListLocs.append(tmp)
        
    # breakpoint()  
    locs=torch.cat(tmpListLocs)
    tmpListActivities=[]
    # location=ValDataLogs[0][0][:,:,0:2]
    for vv in range(len(ValDataLogs)):
        tmp=ValDataLogs[vv][1]
        tmpListActivities.append(tmp)

    actvts=torch.cat(tmpListActivities)
    

    ActivityCollector=np.full([actvts.shape[2],actvts.shape[1]],np.nan)
    for neuronID in range(actvts.size(dim=2)):#
        plt.ioff()
        if torch.max(actvts[:,:,neuronID])>criteria:
            print(neuronID)
            for timeStepOfInput in range(actvts.shape[1]):
                nrn=actvts[:,:,neuronID]
                nrn=nrn[:,timeStepOfInput]
                # activeIndz=nrn>criteria
                # locsAndActvts=torch.stack([locs[trialNum,activeIndz].cpu(),nrn[nrn>criteria]]).T
                ActivityCollector[neuronID,timeStepOfInput]=torch.sum(nrn[nrn>criteria])
        fig = plt.figure()
        ax = plt.subplot(111)
        # ax.hist(locs[activeIndz].cpu(),100,[0,100])#linspace(0, 10,locs[activeIndz].shape[0])
        ax.plot(ActivityCollector[neuronID,:],'.k')

        # print(locs[activeIndz])
        # ax.scatter(locationPast[activeIndz,:].cpu()[:,0],locationPast[activeIndz,:].cpu()[:,1],marker='.',c='r')
        # ax.set_xlim(0,100)
        # ax.set_ylim(0.95,1.05)
        # plt.title('Neuron'+str(neuronID))
        # ax.legend('FiringLocation')
        # plt.show()
        fig.savefig('Neuron'+str(neuronID)+'TimeProfile.png')
        plt.close(fig)

   
        FiringsUnsorted=ActivityCollector
        fig=plt.figure()
        sns.heatmap(FiringsUnsorted)
        fig.savefig('Neuron'+str(neuronID)+'TrialbyTrial.png')

   
   
def oddAndEvenPlaceHeatMaps(ValDataLogs,criteria=0):
    tmpListLocs=[]
    
    for vv in range(len(ValDataLogs)):
        tmp=ValDataLogs[vv][0][:,:,0]
        tmpListLocs.append(tmp)
        
    # breakpoint()  
    locs=torch.cat(tmpListLocs)
    tmpListActivities=[]
    # location=ValDataLogs[0][0][:,:,0:2]
    for vv in range(len(ValDataLogs)):
        tmp=ValDataLogs[vv][1]
        tmpListActivities.append(tmp)
    
    actvts=torch.cat(tmpListActivities)
        

    ActivityCollectorOdd=[]
    ActivityCollectorEven=[]
    for neuronID in range(actvts.size(dim=2)):#
        ActivityCollectorOddNrnLvl=[]
        ActivityCollectorEvenNrnLvl=[]

        
        plt.ioff()
        if torch.max(actvts[:,:,neuronID])>criteria:
            for trialNum in range(actvts.shape[0]):
                nrn=actvts[:,:,neuronID]
                nrn=nrn[trialNum,:]
                if torch.max(nrn)>criteria:
                    if trialNum%2==0:
                        activeIndz=nrn>criteria
                        locsAndActvts=torch.stack([locs[trialNum,activeIndz].cpu(),nrn[nrn>criteria]]).T
                        NoOfBins=100
                        firingSumsInEachBin=np.full([NoOfBins],0.0)
                        for binNo in range(NoOfBins):
                            binMembers=locsAndActvts[torch.where((locsAndActvts[:,0] >= binNo*(100/NoOfBins)) & (locsAndActvts[:,0] <= (binNo+1)*(100/NoOfBins)))]
                            firingSumsInEachBin[binNo]=torch.sum(binMembers)
                        # breakpoint()
                        ActivityCollectorEvenNrnLvl.append(firingSumsInEachBin)

                        
                    else:
                        activeIndz=nrn>criteria
                        locsAndActvts=torch.stack([locs[trialNum,activeIndz].cpu(),nrn[nrn>criteria]]).T
                        NoOfBins=100
                        firingSumsInEachBin=np.full([NoOfBins],0.0)
                        for binNo in range(NoOfBins):
                            binMembers=locsAndActvts[torch.where((locsAndActvts[:,0] >= binNo*(100/NoOfBins)) & (locsAndActvts[:,0] < (binNo+1)*(100/NoOfBins)))]
                            firingSumsInEachBin[binNo]=torch.sum(binMembers)
                        ActivityCollectorOddNrnLvl.append(firingSumsInEachBin)

            neuronIDEvenSum=np.sum(np.vstack(ActivityCollectorEvenNrnLvl),0)
            neuronIDOddSum=np.sum(np.vstack(ActivityCollectorOddNrnLvl),0)
            ActivityCollectorEven.append(neuronIDEvenSum/np.max(neuronIDEvenSum))
            ActivityCollectorOdd.append(neuronIDOddSum/np.max(neuronIDOddSum))

    FiringsUnsortedEven=np.vstack(ActivityCollectorEven) 
    FiringsUnsortedOdd=np.vstack(ActivityCollectorOdd)   
        
    return(FiringsUnsortedEven,FiringsUnsortedOdd)



def firingSorter(FiringsUnsorted):
        tmpListActivities=[]
        # location=ValDataLogs[0][0][:,:,0:2]
        for vv in range(len(ValDataLogs)):
            tmp=ValDataLogs[vv][1]
            tmpListActivities.append(tmp)
        
        actvts=torch.cat(tmpListActivities)
        indxHolder=np.full([actvts.size(dim=2),2],np.nan)
        for NeuronID in range(size(FiringsUnsorted,axis=0)):#
            indxHolder[NeuronID]=[NeuronID,np.argmax(FiringsUnsorted[NeuronID])]
            

        indxHolder=indxHolder[~np.isnan(indxHolder[:,1])]
        sortedIndcs=sorted(indxHolder, key=lambda indxHolder: indxHolder[1])  
        LocHistArraySortedMax=np.full([size(FiringsUnsorted,axis=0),size(FiringsUnsorted,axis=1)],np.nan)
        
        for NeuronID in range(len(FiringsUnsorted)):#
            LocHistArraySortedMax[NeuronID]=FiringsUnsorted[int(sortedIndcs[NeuronID][0])]
             
        plt.ion()    
        fig=plt.figure()
        sns.heatmap(LocHistArraySortedMax)
        fig.savefig('HistSortedBasedOnMax.png')


        
        indxHolder=np.full([FiringsUnsorted.shape[0],2],np.nan)
        indxHolder[:,0]=range(FiringsUnsorted.shape[0])
        indxHolder[:,1]=(FiringsUnsorted!=0).argmax(axis=1)        

        
        sortedIndcs=sorted(indxHolder, key=lambda indxHolder: indxHolder[1])  
        LocHistArraySortedFirts2Fire=np.full([size(FiringsUnsorted,axis=0),size(FiringsUnsorted,axis=1)],np.nan)
        
        for NeuronID in range(len(FiringsUnsorted)):#
            LocHistArraySortedFirts2Fire[NeuronID]=FiringsUnsorted[int(sortedIndcs[NeuronID][0])]
             
        plt.ion()    
        fig=plt.figure()
        sns.heatmap(LocHistArraySortedFirts2Fire)
        fig.savefig('HistSortedBasedOnFirst.png')
            
            
        # locCollectorEven=[]
        # locCollectorOdd=[]
        # for neuronID in range(actvts.size(dim=2)):#
        #     for trialNum in range(actvts.shape[0]):#
        #         if trialNum%2==0:
        #             nrnEven=actvts[trialNum,:,neuronID]
        #             if nrnEven.any()>(torch.mean(nrnEven)+torch.std(nrnEven)*stdVal):
        #                 activeIndzEven=nrnEven>(torch.mean(nrnEven)+torch.std(nrnEven)*stdVal)
        #                 locCollectorEven.append(locs[trialNum,activeIndzEven].cpu())
        #         else:
        #             nrnOdd=actvts[trialNum,:,neuronID]
        #             if nrnOdd.any()>(torch.mean(nrnOdd)+torch.std(nrnOdd)*stdVal):
        #                 activeIndzOdd=nrnOdd>(torch.mean(nrnOdd)+torch.std(nrnOdd)*stdVal)
        #                 locCollectorOdd.append(locs[trialNum,activeIndzOdd].cpu())               
         
        return [LocHistArraySortedMax,LocHistArraySortedFirts2Fire]      

            
            
            
            
            
        
             
            
            















def plotPlaceHist(ValDataLogs,thresh,stdVal,criteria=0):

    tmpListLocs=[]
    
    for vv in range(len(ValDataLogs)):
        tmp=ValDataLogs[vv][0][:,:,0]
        tmpListLocs.append(tmp)
        
    # breakpoint()  
    locs=torch.cat(tmpListLocs)
    tmpListActivities=[]
    # location=ValDataLogs[0][0][:,:,0:2]
    for vv in range(len(ValDataLogs)):
        tmp=ValDataLogs[vv][1]
        tmpListActivities.append(tmp)
    
    actvts=torch.cat(tmpListActivities)
        
    locCollector=[] 
    plt.ioff()
    for neuronID in range(actvts.size(dim=2)):#
        nrn=actvts[:,:,neuronID]
        criteria=criteria
        if thresh:
                criteria=(torch.mean(nrn)+torch.std(nrn)*stdVal)
        activeIndz=nrn>criteria
        fig = plt.figure()
        ax = plt.subplot(111)
        # ax.hist(locs[activeIndz].cpu(),100,[0,100])#linspace(0, 10,locs[activeIndz].shape[0])
        ax.plot(locs[activeIndz].cpu(),nrn[nrn>criteria],'.k')
        locCollector.append(locs[activeIndz].cpu())
        # print(locs[activeIndz])
        # ax.scatter(locationPast[activeIndz,:].cpu()[:,0],locationPast[activeIndz,:].cpu()[:,1],marker='.',c='r')
        ax.set_xlim(0,100)
        # ax.set_ylim(0.95,1.05)
        # plt.title('Neuron'+str(neuronID))
        # ax.legend('FiringLocation')
        # plt.show()
        fig.savefig('Neuron'+str(neuronID)+'.png')
        plt.close(fig)
        
    # locCollectorEven=[]
    # locCollectorOdd=[]
    # for neuronID in range(actvts.size(dim=2)):#
    #     for trialNum in range(actvts.shape[0]):#
    #         if trialNum%2==0:
    #             nrnEven=actvts[trialNum,:,neuronID]
    #             if nrnEven.any()>(torch.mean(nrnEven)+torch.std(nrnEven)*stdVal):
    #                 activeIndzEven=nrnEven>(torch.mean(nrnEven)+torch.std(nrnEven)*stdVal)
    #                 locCollectorEven.append(locs[trialNum,activeIndzEven].cpu())
    #         else:
    #             nrnOdd=actvts[trialNum,:,neuronID]
    #             if nrnOdd.any()>(torch.mean(nrnOdd)+torch.std(nrnOdd)*stdVal):
    #                 activeIndzOdd=nrnOdd>(torch.mean(nrnOdd)+torch.std(nrnOdd)*stdVal)
    #                 locCollectorOdd.append(locs[trialNum,activeIndzOdd].cpu())               
     
    return [locCollector,actvts]           


      
   
def showTrials(ValDataLogs,criteria=-np.inf):
    tmpListLocs=[]
    
    for vv in range(len(ValDataLogs)):
        tmp=ValDataLogs[vv][0][:,:,0]
        tmpListLocs.append(tmp)
        
    # breakpoint()  
    locs=torch.cat(tmpListLocs)
    tmpListActivities=[]
    # location=ValDataLogs[0][0][:,:,0:2]
    for vv in range(len(ValDataLogs)):
        tmp=ValDataLogs[vv][1]
        tmpListActivities.append(tmp)
    
    actvts=torch.cat(tmpListActivities)
        

    maxLocationPossible=1800
    for neuronID in range(actvts.size(dim=2)):#

        ActivityCollector=[]
        plt.ioff()
        # if 1==1:
        if torch.max(actvts[:,:,neuronID])>criteria:
            # print(neuronID)
            for trialNum in range(actvts.shape[0]):
                nrn=actvts[:,:,neuronID]
                nrn=nrn[trialNum,:]
                activeIndz=nrn>criteria
                locsAndActvts=torch.stack([locs[trialNum,activeIndz].cpu(),nrn[nrn>criteria]]).T
                NoOfBins=100
                # im probably summing locs instead of activities
                # firingSumsInEachBin=np.full([NoOfBins],np.nan)
                firingMeanInEachBin = np.full([NoOfBins*2], np.nan)
                binIncrement=maxLocationPossible/NoOfBins
                for binNo in range(-NoOfBins,NoOfBins):
                    binMembers = locsAndActvts[torch.where((locsAndActvts[:, 0] >= binNo*binIncrement) & (locsAndActvts[:, 0] < (binNo+1)*binIncrement))]
       
                    # binMembers=locsAndActvts[torch.where((locsAndActvts[:,0] >= binNo*(100/NoOfBins)) & (locsAndActvts[:,0] <= (binNo+1)*(100/NoOfBins)))]
                    if binMembers.shape[0]>0:
                        firingMeanInEachBin[binNo+NoOfBins]=torch.mean(binMembers[:,1])

                ActivityCollector.append(firingMeanInEachBin)
   
            FiringsUnsorted=np.vstack(ActivityCollector)  
            fig=plt.figure()
            sns.heatmap(FiringsUnsorted)
            ticklabels=np.linspace(-100,100,9)
            plt.xticks(np.linspace(0,200,9),ticklabels)

            fig.savefig('Neuron'+str(neuronID)+'TrialbyTrial.png')
            plt.close(fig)
            # fig=plt.figure()
            # plt.plot(np.sum(FiringsUnsorted,axis=0))
            # fig.savefig('Neuron'+str(neuronID)+'SumOfTrialbyTrial.png')
            # plt.close(fig)
            fig=plt.figure()
            plt.plot(np.nanmean(FiringsUnsorted,axis=0))
            plt.xlim([0,2*NoOfBins])
            ticklabels=np.linspace(-100,100,9)
            plt.xticks(np.linspace(0,200,9),ticklabels)
            fig.savefig('Neuron'+str(neuronID)+'MeanOfTrialbyTrial.png')
            # plt.close(fig)
            # fig=plt.figure()
            # tmp=np.mean(FiringsUnsorted,axis=0)
            # plt.plot((tmp)/np.max(tmp))
            # fig.savefig('Neuron'+str(neuronID)+'NormalizedMeanOfTrialbyTrial.png')
            # plt.close(fig)


def plotDecayUnitsPredictionsAndErrors(ValDataLogs):
    plt.figure()
    plt.plot(ValDataLogs[4][4][100][:,0])
    plt.plot(ValDataLogs[4][3][100][:,0])                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
    plt.legend(["Target","Predicted"])
    

    #         locsAndActvts = torch.stack([Xlocs[activeIndz].cpu(),Ylocs[activeIndz].cpu(),nrn[nrn > criteria]]).T
    #         NoOfBins = 100
    #         firingSumsInEachBin = np.full([NoOfBins,2], 0.0)
    #         binIncrement=maxLocationPossible/100
    #         for binNo in range(NoOfBins):
    #             XbinMembers = locsAndActvts[torch.where((locsAndActvts[:, 0] >= binNo*binIncrement) & (locsAndActvts[:, 0] <= (binNo+1)*binIncrement))]
    #             YbinMembers = locsAndActvts[torch.where((locsAndActvts[:, 1] >= binNo*binIncrement) & (locsAndActvts[:, 1] <= (binNo+1)*binIncrement))]
    #            # (100/NoOfBins)*(100/NoOfBins)
    #             if XbinMembers.shape[0]>0:
    #                 # print(binMembers)
    #                 firingSumsInEachBin[binNo,0] = torch.mean(XbinMembers[:,2])
    #             if YbinMembers.shape[0]>0:
    #                 firingSumsInEachBin[binNo,1] = torch.mean(YbinMembers[:,2])
    #         ActivityCollectorX[neuronID, :] = (firingSumsInEachBin[:,0])/np.max(firingSumsInEachBin[:,0])
    #         ActivityCollectorY[neuronID, :] = (firingSumsInEachBin[:,1])/np.max(firingSumsInEachBin[:,1])
    # noOfNeurons=len(activeNrnCounter)
    # PlaceFieldBlank2D = np.full(
    #     [noOfNeurons,ActivityCollectorX.shape[0], ActivityCollectorX.shape[0]], 0.0)
    # for neuronID in range(noOfNeurons):
    #     for XbinNo in range(ActivityCollectorX.shape[0]):
    #         for YbinNo in range(ActivityCollectorY.shape[0]):
    #             PlaceFieldBlank2D[neuronID,YbinNo,XbinNo]=np.sum([ActivityCollectorX[activeNrnCounter[neuronID],XbinNo],ActivityCollectorY[activeNrnCounter[neuronID],YbinNo]])
    # for neuronID in range(noOfNeurons):       
    #     plt.ioff()
    #     fig = plt.figure()
    #     sns.heatmap(PlaceFieldBlank2D[neuronID])
    #     fig.savefig('2DNeuron'+str(neuronID)+'.png')

















    # ActivityCollector4Time = np.full(
    #     [actvts.shape[2], actvts.shape[1]], np.nan)
    # plt.ioff()
    # for neuronID in range(actvts.size(dim=2)):
    #     # criteria = (torch.mean(actvts[:, :, neuronID]) +
    #     #             torch.std(actvts[:, :, neuronID])*stdVal)
    #     if torch.max(actvts[:, :, neuronID]) > criteria:
    #         ActivityCollector4Time[neuronID, :]=0
    #         print(neuronID)
    #         for timeStepOfInput in range(actvts.shape[1]):
    #             nrn = actvts[:, :, neuronID]
    #             nrn = nrn[:, timeStepOfInput]
    #             # activeIndz=nrn>criteria
    #             # locsAndActvts=torch.stack([locs[trialNum,activeIndz].cpu(),nrn[nrn>criteria]]).T
    #             tmp=torch.mean(nrn[nrn > criteria])
    #             if tmp>0:
    #                 ActivityCollector4Time[neuronID, timeStepOfInput] = torch.mean(nrn[nrn > criteria])
    #         ActivityCollector4Time[neuronID, :] = ActivityCollector4Time[neuronID,:]/np.max(ActivityCollector4Time[neuronID, :])
    # ### time ####
    # indxHolderTime = np.full([actvts.size(dim=2), 2], np.nan)
    # for NeuronID in range(np.size(ActivityCollector4Time, axis=0)):
    #     indxHolderTime[NeuronID] = [NeuronID, np.argmax(ActivityCollector4Time[NeuronID])]

    # indxHolderTime = indxHolderTime[~np.isnan(indxHolderTime[:, 1])]
    # sortedIndcsTime = sorted(indxHolderTime, key=lambda indxHolderTime: indxHolderTime[1])
    # #### time ####
    # FiringsUnsorted = ActivityCollectorX
    # indxHolder = np.full([actvts.size(dim=2), 2], np.nan)
    # for NeuronID in range(np.size(FiringsUnsorted, axis=0)):
    #     indxHolder[NeuronID] = [NeuronID, np.argmax(FiringsUnsorted[NeuronID])]

    # indxHolder = indxHolder[~np.isnan(indxHolder[:, 1])]
    # sortedIndcs = sorted(indxHolder, key=lambda indxHolder: indxHolder[1])

    # XLocHistArraySortedMax = np.full(
    #     [np.size(FiringsUnsorted, axis=0), np.size(FiringsUnsorted, axis=1)], np.nan)

    # for NeuronID in range(len(FiringsUnsorted)):
    #     XLocHistArraySortedMax[NeuronID] = FiringsUnsorted[int(
    #         sortedIndcs[NeuronID][0])]
        
        
    #     ## Y axis
    # FiringsUnsorted = ActivityCollectorY
    # indxHolder = np.full([actvts.size(dim=2), 2], np.nan)
    # for NeuronID in range(np.size(FiringsUnsorted, axis=0)):
    #     indxHolder[NeuronID] = [NeuronID, np.argmax(FiringsUnsorted[NeuronID])]

    # indxHolder = indxHolder[~np.isnan(indxHolder[:, 1])]
    # sortedIndcs = sorted(indxHolder, key=lambda indxHolder: indxHolder[1])

    # YLocHistArraySortedMax = np.full(
    #     [np.size(FiringsUnsorted, axis=0), np.size(FiringsUnsorted, axis=1)], np.nan)

    # for NeuronID in range(len(FiringsUnsorted)):
    #     YLocHistArraySortedMax[NeuronID] = FiringsUnsorted[int(
    #         sortedIndcs[NeuronID][0])]     

    # TimeHistArraySortedMax = np.full(
    #     [np.size(ActivityCollector4Time, axis=0), np.size(ActivityCollector4Time, axis=1)], np.nan)

    # for NeuronID in range(len(FiringsUnsorted)):
    #     TimeHistArraySortedMax[NeuronID] = ActivityCollector4Time[int(
    #         sortedIndcsTime[NeuronID][0])]
    # # This is for ploting Location and time profiles agoinst each other
    # # plt.ioff()
    # # for NeuronID in range(len(FiringsUnsorted)): 
    # #     fig = plt.figure()
    # #     plt.plot(ActivityCollector[NeuronID,:])
    # #     plt.plot(ActivityCollector4Time[NeuronID,:])
    # #     plt.legend(['Location','time'])
    # #     fig.savefig('FiringProfileOfNeuron'+ str(NeuronID) +'LocationVsTime'+ '.png') 
        
    # XLocHistArraySortedMax[np.isnan(
    #     XLocHistArraySortedMax[:, 1])]=0
    # YLocHistArraySortedMax[np.isnan(
    #     YLocHistArraySortedMax[:, 1])]=0
    
    # TimeHistArraySortedMax = TimeHistArraySortedMax[~np.isnan(
    #     TimeHistArraySortedMax[:, 1])]
    # plt.ion()
    # fig = plt.figure()
    # sns.heatmap(YLocHistArraySortedMax)
    # fig.savefig('HeatMapOfLocationFiringSortedBasedOnMaxFiring.png')
    # plt.ion()
    # fig = plt.figure()
    # sns.heatmap(XLocHistArraySortedMax)
    # fig.savefig('HeatMapOfLocationFiringSortedBasedOnMaxFiring.png')
    # fig = plt.figure()
    # sns.heatmap(TimeHistArraySortedMax)
    # fig.savefig('HeatMapOfTimeFiringSortedBasedOnMaxFiring.png')

    # indxHolder = np.full([FiringsUnsorted.shape[0], 2], np.nan)
    # indxHolder[:, 0] = range(FiringsUnsorted.shape[0])
    # indxHolder[:, 1] = (FiringsUnsorted != 0).argmax(axis=1)

    # sortedIndcs = sorted(indxHolder, key=lambda indxHolder: indxHolder[1])
    # ### time ####
    # indxHolderTime = np.full([actvts.size(dim=2), 2], np.nan)
    # indxHolder[:, 0] = range(ActivityCollector4Time.shape[0])
    # indxHolder[:, 1] = (ActivityCollector4Time != 0).argmax(axis=1)
    # for NeuronID in range(np.size(FiringsUnsorted, axis=0)):
    #     indxHolderTime[NeuronID] = [NeuronID, np.argmax(ActivityCollector4Time[NeuronID])]

    # indxHolderTime = indxHolderTime[~np.isnan(indxHolder[:, 1])]
    # sortedIndcsTime = sorted(indxHolderTime, key=lambda indxHolderTime: indxHolderTime[1])
    # #### time ####
    # LocHistArraySortedFirts2Fire = np.full(
    #     [np.size(FiringsUnsorted, axis=0), np.size(FiringsUnsorted, axis=1)], np.nan)

    # for NeuronID in range(len(FiringsUnsorted)):
    #     LocHistArraySortedFirts2Fire[NeuronID] = FiringsUnsorted[int(
    #         sortedIndcs[NeuronID][0])]

    # TimeHistArraySortedFirts2Fire = np.full(
    #     [np.size(ActivityCollector4Time, axis=0), np.size(ActivityCollector4Time, axis=1)], np.nan)

    # for NeuronID in range(len(FiringsUnsorted)):
    #     TimeHistArraySortedFirts2Fire[NeuronID] = ActivityCollector4Time[int(
    #         sortedIndcsTime[NeuronID][0])]

    # LocHistArraySortedFirts2Fire = LocHistArraySortedFirts2Fire[~np.isnan(
    #     LocHistArraySortedFirts2Fire[:, 1])]
    # TimeHistArraySortedFirts2Fire = TimeHistArraySortedFirts2Fire[~np.isnan(
    #     TimeHistArraySortedFirts2Fire[:, 1])]

    # plt.ion()
    # fig = plt.figure()
    # sns.heatmap(LocHistArraySortedFirts2Fire)
    # fig.savefig('HeatMapOfLocationFiringSortedBasedOnFirstFiring.png')

    # fig = plt.figure()
    # sns.heatmap(TimeHistArraySortedFirts2Fire)
    # fig.savefig('HeatMapOfTimeFiringSortedBasedOnFirstFiring.png')

    
####################################################
# stdVal=2
# [locCollector,actvts]  =plotPlaceHist(ValDataLogs,False,stdVal)
# [LocHistArraySortedMax,LocHistArraySortedFirts2Fire]  =plotPlaceFields(ValDataLogs,False,stdVal)

# showTrials(ValDataLogs,criteria=.5)
    
# [FiringsUnsortedEven,FiringsUnsortedOdd]=oddAndEvenPlaceHeatMaps(ValDataLogs,criteria=0)
#         locsAndActvts = torch.stack([Xlocs[activeIndz].cpu(),Ylocs[activeIndz].cpu(),nrn[nrn > criteria]]).T
    #         NoOfBins = 100
    #         firingSumsInEachBin = np.full([NoOfBins,2], 0.0)
    #         binIncrement=maxLocationPossible/100
    #         for binNo in range(NoOfBins):
    #             XbinMembers = locsAndActvts[torch.where((locsAndActvts[:, 0] >= binNo*binIncrement) & (locsAndActvts[:, 0] <= (binNo+1)*binIncrement))]
    #             YbinMembers = locsAndActvts[torch.where((locsAndActvts[:, 1] >= binNo*binIncrement) & (locsAndActvts[:, 1] <= (binNo+1)*binIncrement))]
    #            # (100/NoOfBins)*(100/NoOfBins)
    #             if XbinMembers.shape[0]>0:
    #                 # print(binMembers)
    #                 firingSumsInEachBin[binNo,0] = torch.mean(XbinMembers[:,2])
    #             if YbinMembers.shape[0]>0:
    #                 firingSumsInEachBin[binNo,1] = torch.mean(YbinMembers[:,2])
    #         ActivityCollectorX[neuronID, :] = (firingSumsInEachBin[:,0])/np.max(firingSumsInEachBin[:,0])
    #         ActivityCollectorY[neuronID, :] = (firingSumsInEachBin[:,1])/np.max(firingSumsInEachBin[:,1])
    # noOfNeurons=len(activeNrnCounter)
    # PlaceFieldBlank2D = np.full(
    #     [noOfNeurons,ActivityCollectorX.shape[0], ActivityCollectorX.shape[0]], 0.0)
    # for neuronID in range(noOfNeurons):
    #     for XbinNo in range(ActivityCollectorX.shape[0]):
    #         for YbinNo in range(ActivityCollectorY.shape[0]):
    #             PlaceFieldBlank2D[neuronID,YbinNo,XbinNo]=np.sum([ActivityCollectorX[activeNrnCounter[neuronID],XbinNo],ActivityCollectorY[activeNrnCounter[neuronID],YbinNo]])
    # for neuronID in range(noOfNeurons):       
    #     plt.ioff()
    #     fig = plt.figure()
    #     sns.heatmap(PlaceFieldBlank2D[neuronID])
    #     fig.savefig('2DNeuron'+str(neuronID)+'.png')

















    # ActivityCollector4Time = np.full(
    #     [actvts.shape[2], actvts.shape[1]], np.nan)
    # plt.ioff()
    # for neuronID in range(actvts.size(dim=2)):
    #     # criteria = (torch.mean(actvts[:, :, neuronID]) +
    #     #             torch.std(actvts[:, :, neuronID])*stdVal)
    #     if torch.max(actvts[:, :, neuronID]) > criteria:
    #         ActivityCollector4Time[neuronID, :]=0
    #         print(neuronID)
    #         for timeStepOfInput in range(actvts.shape[1]):
    #             nrn = actvts[:, :, neuronID]
    #             nrn = nrn[:, timeStepOfInput]
    #             # activeIndz=nrn>criteria
    #             # locsAndActvts=torch.stack([locs[trialNum,activeIndz].cpu(),nrn[nrn>criteria]]).T
    #             tmp=torch.mean(nrn[nrn > criteria])
    #             if tmp>0:
    #                 ActivityCollector4Time[neuronID, timeStepOfInput] = torch.mean(nrn[nrn > criteria])
    #         ActivityCollector4Time[neuronID, :] = ActivityCollector4Time[neuronID,:]/np.max(ActivityCollector4Time[neuronID, :])
    # ### time ####
    # indxHolderTime = np.full([actvts.size(dim=2), 2], np.nan)
    # for NeuronID in range(np.size(ActivityCollector4Time, axis=0)):
    #     indxHolderTime[NeuronID] = [NeuronID, np.argmax(ActivityCollector4Time[NeuronID])]

    # indxHolderTime = indxHolderTime[~np.isnan(indxHolderTime[:, 1])]
    # sortedIndcsTime = sorted(indxHolderTime, key=lambda indxHolderTime: indxHolderTime[1])
    # #### time ####
    # FiringsUnsorted = ActivityCollectorX
    # indxHolder = np.full([actvts.size(dim=2), 2], np.nan)
    # for NeuronID in range(np.size(FiringsUnsorted, axis=0)):
    #     indxHolder[NeuronID] = [NeuronID, np.argmax(FiringsUnsorted[NeuronID])]

    # indxHolder = indxHolder[~np.isnan(indxHolder[:, 1])]
    # sortedIndcs = sorted(indxHolder, key=lambda indxHolder: indxHolder[1])

    # XLocHistArraySortedMax = np.full(
    #     [np.size(FiringsUnsorted, axis=0), np.size(FiringsUnsorted, axis=1)], np.nan)

    # for NeuronID in range(len(FiringsUnsorted)):
    #     XLocHistArraySortedMax[NeuronID] = FiringsUnsorted[int(
    #         sortedIndcs[NeuronID][0])]
        
        
    #     ## Y axis
    # FiringsUnsorted = ActivityCollectorY
    # indxHolder = np.full([actvts.size(dim=2), 2], np.nan)
    # for NeuronID in range(np.size(FiringsUnsorted, axis=0)):
    #     indxHolder[NeuronID] = [NeuronID, np.argmax(FiringsUnsorted[NeuronID])]

    # indxHolder = indxHolder[~np.isnan(indxHolder[:, 1])]
    # sortedIndcs = sorted(indxHolder, key=lambda indxHolder: indxHolder[1])

    # YLocHistArraySortedMax = np.full(
    #     [np.size(FiringsUnsorted, axis=0), np.size(FiringsUnsorted, axis=1)], np.nan)

    # for NeuronID in range(len(FiringsUnsorted)):
    #     YLocHistArraySortedMax[NeuronID] = FiringsUnsorted[int(
    #         sortedIndcs[NeuronID][0])]     

    # TimeHistArraySortedMax = np.full(
    #     [np.size(ActivityCollector4Time, axis=0), np.size(ActivityCollector4Time, axis=1)], np.nan)

    # for NeuronID in range(len(FiringsUnsorted)):
    #     TimeHistArraySortedMax[NeuronID] = ActivityCollector4Time[int(
    #         sortedIndcsTime[NeuronID][0])]
    # # This is for ploting Location and time profiles agoinst each other
    # # plt.ioff()
    # # for NeuronID in range(len(FiringsUnsorted)): 
    # #     fig = plt.figure()
    # #     plt.plot(ActivityCollector[NeuronID,:])
    # #     plt.plot(ActivityCollector4Time[NeuronID,:])
    # #     plt.legend(['Location','time'])
    # #     fig.savefig('FiringProfileOfNeuron'+ str(NeuronID) +'LocationVsTime'+ '.png') 
        
    # XLocHistArraySortedMax[np.isnan(
    #     XLocHistArraySortedMax[:, 1])]=0
    # YLocHistArraySortedMax[np.isnan(
    #     YLocHistArraySortedMax[:, 1])]=0
    
    # TimeHistArraySortedMax = TimeHistArraySortedMax[~np.isnan(
    #     TimeHistArraySortedMax[:, 1])]
    # plt.ion()
    # fig = plt.figure()
    # sns.heatmap(YLocHistArraySortedMax)
    # fig.savefig('HeatMapOfLocationFiringSortedBasedOnMaxFiring.png')
    # plt.ion()
    # fig = plt.figure()
    # sns.heatmap(XLocHistArraySortedMax)
    # fig.savefig('HeatMapOfLocationFiringSortedBasedOnMaxFiring.png')
    # fig = plt.figure()
    # sns.heatmap(TimeHistArraySortedMax)
    # fig.savefig('HeatMapOfTimeFiringSortedBasedOnMaxFiring.png')

    # indxHolder = np.full([FiringsUnsorted.shape[0], 2], np.nan)
    # indxHolder[:, 0] = range(FiringsUnsorted.shape[0])
    # indxHolder[:, 1] = (FiringsUnsorted != 0).argmax(axis=1)

    # sortedIndcs = sorted(indxHolder, key=lambda indxHolder: indxHolder[1])
    # ### time ####
    # indxHolderTime = np.full([actvts.size(dim=2), 2], np.nan)
    # indxHolder[:, 0] = range(ActivityCollector4Time.shape[0])
    # indxHolder[:, 1] = (ActivityCollector4Time != 0).argmax(axis=1)
    # for NeuronID in range(np.size(FiringsUnsorted, axis=0)):
    #     indxHolderTime[NeuronID] = [NeuronID, np.argmax(ActivityCollector4Time[NeuronID])]

    # indxHolderTime = indxHolderTime[~np.isnan(indxHolder[:, 1])]
    # sortedIndcsTime = sorted(indxHolderTime, key=lambda indxHolderTime: indxHolderTime[1])
    # #### time ####
    # LocHistArraySortedFirts2Fire = np.full(
    #     [np.size(FiringsUnsorted, axis=0), np.size(FiringsUnsorted, axis=1)], np.nan)

    # for NeuronID in range(len(FiringsUnsorted)):
    #     LocHistArraySortedFirts2Fire[NeuronID] = FiringsUnsorted[int(
    #         sortedIndcs[NeuronID][0])]

    # TimeHistArraySortedFirts2Fire = np.full(
    #     [np.size(ActivityCollector4Time, axis=0), np.size(ActivityCollector4Time, axis=1)], np.nan)

    # for NeuronID in range(len(FiringsUnsorted)):
    #     TimeHistArraySortedFirts2Fire[NeuronID] = ActivityCollector4Time[int(
    #         sortedIndcsTime[NeuronID][0])]

    # LocHistArraySortedFirts2Fire = LocHistArraySortedFirts2Fire[~np.isnan(
    #     LocHistArraySortedFirts2Fire[:, 1])]
    # TimeHistArraySortedFirts2Fire = TimeHistArraySortedFirts2Fire[~np.isnan(
    #     TimeHistArraySortedFirts2Fire[:, 1])]

    # plt.ion()
    # fig = plt.figure()
    # sns.heatmap(LocHistArraySortedFirts2Fire)
    # fig.savefig('HeatMapOfLocationFiringSortedBasedOnFirstFiring.png')

    # fig = plt.figure()
    # sns.heatmap(TimeHistArraySortedFirts2Fire)
    # fig.savefig('HeatMapOfTimeFiringSortedBasedOnFirstFiring.png')

    
####################################################
# stdVal=2
# [locCollector,actvts]  =plotPlaceHist(ValDataLogs,False,stdVal)
# [LocHistArraySortedMax,LocHistArraySortedFirts2Fire]  =plotPlaceFields(ValDataLogs,False,stdVal)

# showTrials(ValDataLogs,criteria=.5)
    
# [FiringsUnsortedEven,FiringsUnsortedOdd]=oddAndEvenPlaceHeatMaps(ValDataLogs,criteria=0)

# firingSorter(FiringsUnsortedEven)








# firingSorter(FiringsUnsortedEven)





# def sortHistogram(locCollector,actvts):
#     LocHistArray=[]
#     # ActvtsHistArray=[]
#     for NeuronID in range(actvts.size(dim=2)):#
#         if torch.sum(locCollector[NeuronID])>0:
#             tmp=plt.hist(locCollector[NeuronID],100)
#             # tmp2=plt.hist(actvts[:,:,NeuronID],100,[0,10])
#             LocHistArray.append(tmp[0]/np.max(tmp[0]))
#             # ActvtsHistArray.append(tmp2[0]/np.nansum(tmp2[0]))
        
#     indxHolder=np.full([100,2],np.nan)
#     for NeuronID in range(len(LocHistArray)):#
#         indxHolder[NeuronID]=[NeuronID,np.argmax(LocHistArray[NeuronID])]
    
#     indxHolder=indxHolder[~np.isnan(indxHolder[:,1])]
#     np.sort(indxHolder,axis=0)
#     sortedIndcs=sorted(indxHolder, key=lambda indxHolder: indxHolder[1])  
#     LocHistArraySorted=np.full([size(LocHistArray,axis=0),100],np.nan)
    
#     for NeuronID in range(len(LocHistArray)):#
#         LocHistArraySorted[NeuronID]=LocHistArray[int(sortedIndcs[NeuronID][0])]
     
#     plt.ion()    
#     fig=plt.figure()
#     sns.heatmap(LocHistArraySorted)
#     fig.savefig('Hist.png')
#     plt.close(fig)
    
    
# def firingHeatMap(locCollector,actvts):

#     for NeuronID in range(actvts.size(dim=2)):#
#         if torch.sum(locCollector[NeuronID])>0:
#             firingSumsInEachBin=indxHolder=np.full([1,10],np.nan)
#             for binNo in range(10):
#                 firingSumsInEachBin[binNo]=locCollector[NeuronID]
#             tmp=plt.hist(locCollector[NeuronID],100)
#             # tmp2=plt.hist(actvts[:,:,NeuronID],100,[0,10])
#             LocHistArray.append(tmp[0]/np.max(tmp[0]))
#             # ActvtsHistArray.append(tmp2[0]/np.nansum(tmp2[0]))
            
            
#         locCollector[NeuronID][locCollector[NeuronID]>0]
        
        
#     indxHolder=np.full([100,2],np.nan)
#     for NeuronID in range(len(LocHistArray)):#
#         indxHolder[NeuronID]=[NeuronID,np.argmax(LocHistArray[NeuronID])]
    
#     indxHolder=indxHolder[~np.isnan(indxHolder[:,1])]
#     np.sort(indxHolder,axis=0)
#     sortedIndcs=sorted(indxHolder, key=lambda indxHolder: indxHolder[1])  
#     LocHistArraySorted=np.full([size(LocHistArray,axis=0),100],np.nan)
    
#     for NeuronID in range(len(LocHistArray)):#
#         LocHistArraySorted[NeuronID]=LocHistArray[int(sortedIndcs[NeuronID][0])]
     
#     plt.ion()    
#     fig=plt.figure()
#     sns.heatmap(LocHistArraySorted)
#     fig.savefig('Hist.png')
#     plt.close(fig)
